<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Optimized RF24Network Layer: Performance and Data Loss: Tuning the Network</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Optimized RF24Network Layer<span id="projectnumber">&#160;v2.0.5</span>
   </div>
   <div id="projectbrief">2024 - Optimized RF24 Network Layer for NRF24L01 &amp; NRF52x radios</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Performance and Data Loss: Tuning the Network</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md137">Understanding Radio Communication and Topology</a></li>
<li class="level1"><a href="#autotoc_md138">Topology of RF24Network</a><ul><li class="level2"><a href="#autotoc_md139">Expressing RF24Network addresses in IP format</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md140">Multicast</a></li>
<li class="level1"><a href="#autotoc_md141">Routing</a></li>
<li class="level1"><a href="#autotoc_md142">Tuning Overview</a></li>
<li class="level1"><a href="#autotoc_md143">Auto-Retry Timing</a></li>
<li class="level1"><a href="#autotoc_md144">Auto-Retry Count and Extended Timeouts</a></li>
<li class="level1"><a href="#autotoc_md145">Usage with NRF52x devices</a></li>
<li class="level1"><a href="#autotoc_md146">Scenarios</a><ul><li class="level2"><a href="#autotoc_md147">Example 1</a></li>
<li class="level2"><a href="#autotoc_md148">Example 2</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="autotoc_md136"></a></p>
<p>Tips and examples for tuning the network and general operation.</p>
<p>Observe:</p>
<p><img src="https://github.com/nRF24/RF24Network/raw/master/images/topologyImage.jpg" alt="@image html images/topologyImage.jpg width=70% height=70%" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md137"></a>
Understanding Radio Communication and Topology</h1>
<p>When a transmission takes place from one radio module to another, the receiving radio will communicate back to the sender with an acknowledgement (ACK) packet, to indicate success. If the sender does not receive an ACK, the radio automatically engages in a series of timed retries, at set intervals. The radios use techniques like addressing and numbering of payloads to manage this, but it is all done automatically by the nrf chip, out of sight from the user.</p>
<p>When working over a radio network, some of these automated techniques can actually hinder data transmission to a degree. Retrying failed payloads over and over on a radio network can hinder communication for nearby nodes, or reduce throughput and errors on routing nodes.</p>
<p>Radios in this network are linked by <b>addresses</b> assigned to <b>pipes</b>. Each radio can listen to 6 addresses on 6 pipes, (8 pipes on NRF52x) therefore each radio has a parent pipe and 4-5 child pipes, which are used to form a tree structure. Nodes communicate directly with their parent and children nodes. Any other traffic to or from a node must be routed through the network.</p>
<h1><a class="anchor" id="autotoc_md138"></a>
Topology of RF24Network</h1>
<p>Anybody who is familiar at all with IP networking should be able to easily understand RF24Network topology. The master node can be seen as the gateway, with (by default) up to 5 directly connected nodes. Each of those nodes creates a subnet below it, with up to 4 additional child nodes. The numbering scheme can also be related to IP addresses, for purposes of understanding the topology via subnetting. Nodes can have 5 children if multicast is disabled.</p>
<h2><a class="anchor" id="autotoc_md139"></a>
Expressing RF24Network addresses in IP format</h2>
<p>As an example, we could designate the master node in theory, as Address <code>10.10.10.10</code></p>
<ul>
<li>The children nodes of the master would be <code>10.10.10.1</code>, <code>10.10.10.2</code>, <code>10.10.10.3</code>, <code>10.10.10.4</code> and <code>10.10.10.5</code></li>
<li>The children nodes of <code>10.10.10.1</code> would be <code>10.10.1.1</code>, <code>10.10.2.1</code>, <code>10.10.3.1</code>, <code>10.10.4.1</code> and <code>10.10.5.1</code></li>
</ul>
<p>In RF24Network, the master is just <code>00</code></p>
<ul>
<li>Children of master are <code>01</code>, <code>02</code>, <code>03</code>, <code>04</code>, <code>05</code></li>
<li>Children of <code>01</code> are <code>011</code>, <code>021</code>, <code>031</code>, <code>041</code>, <code>051</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md140"></a>
Multicast</h1>
<p>Multicast is enabled by default, which limits the master node to 5 child pipes and other nodes to 4 when using RF24 modules. Nodes are arranged in multicast 'levels' with the master node being level 0, nodes 01-05 are level 1, nodes n1-n5 are level 2, and so on. The multicast level of each node can be configured as desired by the user, or multicast can be disabled by editing <a class="el" href="RF24Network__config_8h.html">RF24Network_config.h</a>. For example, if all nodes are in range of the master node, all nodes can be configured to use multicast level 1, allowing the master node to contact all of them by sending a single payload. Multicasting is also used by the RF24Mesh layer for dynamic addressing requests.</p>
<h1><a class="anchor" id="autotoc_md141"></a>
Routing</h1>
<p>Routing of traffic is handled invisibly to the user, by the network layer. If the network addresses are assigned in accordance with the physical layout of the network, nodes will route traffic automatically as required. Users simply construct a header containing the appropriate destination address, and the network will forward it through to the correct node. Individual nodes only route individual fragments, so if using fragmentation, routing nodes do not need it enabled, unless sending or receiving fragmented payloads themselves.</p>
<p>If routing data between parent and child nodes (marked by direct links on the topology image above) the network uses built-in acknowledgement and retry functions of the chip to prevent data loss. When payloads are sent to other nodes, they need to be routed. Routing is managed using a combination of built in ACK requests, and software driven network ACKs. This allows all routing nodes to forward data very quickly, with only the final routing node confirming delivery and sending back an acknowledgement.</p>
<p>Example: Node 00 sends to node 01. The nodes will use the built in auto-retry and auto-ack functions.</p>
<p>Example: Node 00 sends to node 011. Node 00 will send to node 01 as before. Node 01 will forward the message to 011. If delivery was successful, node 01 will also forward a message back to node 00, indicating success.</p>
<p>Old Functionality: Node 00 sends to node 011 using auto-ack. Node 00 first sends to 01, 01 acknowledges. Node 01 forwards the payload to 011 using auto-ack. If the payload fails between 01 and 011, node 00 has no way of knowing.</p>
<dl class="section note"><dt>Note</dt><dd>When retrying failed payloads that have been routed, there is a chance of duplicate payloads if the network-ack is not successful. In this case, it is left up to the user to manage retries and filtering of duplicate payloads.</dd></dl>
<p>Acknowledgements can and should be managed by the application or user. If requesting a response from another node, an acknowledgement is not required, so a user defined type of 0-64 should be used, to prevent the network from responding with an acknowledgement. If not requesting a response, and wanting to know if the payload was successful or not, users can utilize header types 65-127.</p>
<h1><a class="anchor" id="autotoc_md142"></a>
Tuning Overview</h1>
<p>The RF24 radio modules are generally only capable of either sending or receiving data at any given time, but have built-in auto-retry mechanisms to prevent the loss of data. These values are adjusted automatically by the library on startup, but can be further adjusted to reduce data loss, and thus increase throughput of the network. This page is intended to provide a general overview of its operation within the context of the network library, and provide guidance for adjusting these values.</p>
<h1><a class="anchor" id="autotoc_md143"></a>
Auto-Retry Timing</h1>
<p>The core radio library provides the functionality of adjusting the internal auto-retry interval of the radio modules. In the network configuration, the radios can be set to automatically retry failed transmissions at intervals ranging anywhere from 500us (0.5ms) up to 4000us (4ms). When operating any number of radios larger than two, it is important to stagger the assigned intervals, to prevent the radios from interfering with each other at the radio frequency (RF) layer.</p>
<p>The library should provide fairly good working values, as it simply staggers the assigned values within groups of radios in direct communication. This value can be set manually by calling <code>radio.setRetries(X, 15);</code> and adjusting the value of X from 1 to 15 (steps of 250us).</p>
<h1><a class="anchor" id="autotoc_md144"></a>
Auto-Retry Count and Extended Timeouts</h1>
<p>The core radio library also provides the ability to adjust the internal auto-retry count of the radio modules. The default setting is 15 automatic retries per payload, and can be extended by configuring the network.txTimeout variable. This default retry count should generally be left at 15, as per the example in the above section. An interval/retry setting of (15,15) will provide 15 retries at intervals of 4ms, taking up to 60ms per payload. The library now provides staggered timeout periods by default, but they can also be adjusted on a per-node basis.</p>
<p>The txTimeout variable is used to extend the retry count to a defined duration in milliseconds. See the network.txTimeout variable. Timeout periods of extended duration (500+) will generally not help when payloads are failing due to data collisions, it will only extend the duration of the errors. Extended duration timeouts should generally only be configured on leaf nodes that do not receive data.</p>
<h1><a class="anchor" id="autotoc_md145"></a>
Usage with NRF52x devices</h1>
<ol type="1">
<li>Users can utilize large payloads by calling <code>radio.begin();</code> then <code>radio.enableDynamicPayloads(123);</code> prior to calling <code>network.begin();</code>. Users would also need to edit <a class="el" href="RF24Network_8h.html">RF24Network.h</a> and set MAX_FRAME_SIZE to a maximum of 111 if encryption is enabled, 123 without encryption.</li>
<li>Users can allow more nodes by modifying <a class="el" href="RF24Network__config_8h.html">RF24Network_config.h</a> and setting NUM_PIPES to 8 (Allows master to have 7 child nodes, other nodes can have 6 children by default)</li>
<li>The MAX_PAYLOAD_SIZE is also defined in <a class="el" href="RF24Network__config_8h.html">RF24Network_config.h</a>. Raise to a multiple of 123 to allow multiple large payloads to be cached in memory.</li>
</ol>
<dl class="section see"><dt>See also</dt><dd><ul>
<li><a href="https://github.com/TMRh20/nrf_to_nrf/blob/main/examples/RF24Network/helloworld_rxEncryption/helloworld_rxEncryption.ino">RX example using encryption</a></li>
<li><a href="https://github.com/TMRh20/nrf_to_nrf/blob/main/examples/RF24Network/helloworld_txEncryption/helloworld_txEncryption.ino">TX example using encryption</a></li>
</ul>
</dd></dl>
<h1><a class="anchor" id="autotoc_md146"></a>
Scenarios</h1>
<h2><a class="anchor" id="autotoc_md147"></a>
Example 1</h2>
<p>Network with master node and three leaf nodes that send data to the master node. None of the leaf nodes need to receive data.</p>
<ol type="1">
<li>Master node uses default configuration</li>
<li>Leaf nodes can be configured with extended timeout periods to ensure reception by the master.</li>
<li>The following configuration will provide a reduction in errors, as the timeouts have been extended and are staggered between devices. <div class="fragment"><div class="line">Leaf 01: network.txTimeout = 500;</div>
<div class="line">Leaf 02: network.txTimeout = 573;</div>
<div class="line">Leaf 03: network.txTimeout = 653;</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md148"></a>
Example 2</h2>
<p>Network with master node and three leaf nodes that send data to the master node. The second leaf node needs to receive configuration data from the master at set intervals of 1 second, and send data back to the master node. The other leaf nodes will send basic sensor information every few seconds, and a few dropped payloads will not affect the operation greatly.</p>
<ol type="1">
<li>Master node configured with extended timeouts of 0.5 seconds, and increased retry delay: <div class="fragment"><div class="line">radio.setRetries(11, 15);</div>
<div class="line">network.txTimeout = 500;</div>
</div><!-- fragment --></li>
<li>Second leaf node configured with a similar timeout period and retry delay: <div class="fragment"><div class="line">radio.setRetries(8, 15);</div>
<div class="line">network.txTimeout = 553;</div>
</div><!-- fragment --></li>
<li>First and third leaf nodes configured with default timeout periods or slightly increased timeout periods. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun May 4 2025 for Optimized RF24Network Layer by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
